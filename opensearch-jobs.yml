instance_groups:
#######################################################
#First deploy group - opensearch_manager, maintenance
#######################################################
- name: opensearch_manager
  instances: 3
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    consumes: &consumes-opensearch-manager
      opensearch:
        from: opensearch_manager
        ip_addresses: true
    provides:
      opensearch:
        as: opensearch_manager
    properties:
      opensearch:
        clustername: opensearch
        limits:
          fd: 131072 # 2 ** 17
        node:
          allow_cluster_manager: true
          allow_data: false
        jvm_options:
          - "-Dlog4j2.formatMsgNoLookups=true"
    release: opensearch
  azs:
  - z1
  persistent_disk: 10240
  stemcell: default
  vm_type: t3.large
  networks:
   - name: services

- name: maintenance
  instances: 1
  vm_extensions: [errand-profile]
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes: *consumes-opensearch-manager
    properties:
      opensearch:
        clustername: opensearch
        limits:
          fd: 131072 # 2 ** 17
        jvm_options:
          - "-Dlog4j2.formatMsgNoLookups=true"
  - name: opensearch_config_lfc
    properties:
      opensearch_config:
        app_index_component_name: index-mappings-app-lfc
        app_index_settings:
          index.mapping.total_fields.limit: 2000
          index.queries.cache.enabled: "false"
        base_index_component_name: index-mappings-lfc
        index_mappings_component_name: index-mappings
        index_settings_component_name: index-settings
        platform_index_component_name: index-mappings-platform-lfc
        shards_and_replicas_component_name: shards-and-replicas
    release: opensearch
  - name: opensearch_config
    release: opensearch
    consumes: *consumes-opensearch-manager
    properties:
      opensearch_config:
        component_templates:
        - shards-and-replicas: /var/vcap/jobs/opensearch_config/index-templates/shards-and-replicas.json
        - index-settings: /var/vcap/jobs/opensearch_config/index-templates/index-settings.json
        - index-mappings: /var/vcap/jobs/opensearch_config/index-templates/index-mappings.json
        - index-mappings-lfc: /var/vcap/jobs/opensearch_config_lfc/component-index-mappings.json
        - index-mappings-app-lfc: /var/vcap/jobs/opensearch_config_lfc/component-index-mappings-app.json
        - index-mappings-platform-lfc: /var/vcap/jobs/opensearch_config_lfc/component-index-mappings-platform.json
        index_templates:
        - index-mappings-lfc: /var/vcap/jobs/opensearch_config_lfc/index-mappings.json
        - index-mappings-app-lfc: /var/vcap/jobs/opensearch_config_lfc/index-mappings-app.json
        - index-mappings-platform-lfc: /var/vcap/jobs/opensearch_config_lfc/index-mappings-platform.json
  stemcell: default
  azs: [z1]
  vm_type: t3.large
  networks:
  - name: services
  update:
    serial: true # Block on this job to create deploy group 1

#########################################################
#2nd deploy group - opensearch_data, opensearch_dashboards, ingestors
#########################################################
- name: opensearch_data
  instances: 11
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes: *consumes-opensearch-manager
    properties:
      opensearch:
        node:
          allow_cluster_manager: false
          allow_data: true
        limits:
          fd: 131072  # 2 ** 17
        health:
          timeout: 900
          disable_post_start: true
        recovery:
          delay_allocation_restart: "15m"
        config_options:
          indices.query.bool.max_clause_count: 2048
        jvm_options:
          - "-Dlog4j2.formatMsgNoLookups=true"
  persistent_disk: 10240
  stemcell: default
  azs: [z1]
  vm_type: t3.large
  networks:
  - name: services
  update:
    max_in_flight: 1 # Only update 1 data node at a time or risk downtime
  env:
    bosh:
      swap_size: 0

- name: opensearch_dashboards
  instances: 2
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes: *consumes-opensearch-manager
  - name: opensearch_dashboards
    consumes: *consumes-opensearch-manager
    properties:
      opensearch_dashboards:
        config_options:
          server.maxPayloadBytes: 4194304
        console.enabled: false
        defaultappid: dashboard/App-Overview
        env:
        - NODE_ENV: production
        health:
          timeout: 600
        memory_limit: 75
    provides:
      opensearch-dashboard:
        as: opensearch_link
    release: opensearch
  - name: route_registrar
    consumes:
      nats-tls:
        deployment: cf-development
        from: nats-tls
    properties:
      nats:
        tls:
          client_cert: ((/bosh/cf-development/nats_client_cert.certificate))
          client_key: ((/bosh/cf-development/nats_client_cert.private_key))
          enabled: true
      route_registrar:
        routes:
        - name: opensearch-dashboard
          port: 5601
          registration_interval: 2s
          timeout: 1s
          uris:
          - logs-beta.dev.us-gov-west-1.aws-us-gov.cloud.gov
    release: routing
  - name: bosh-dns-aliases
    properties:
      aliases:
      - domain: nats.service.cf.internal
        targets:
        - deployment: cf-development
          domain: bosh
          instance_group: nats
          network: default
          query: '*'
    release: bosh-dns-aliases
  persistent_disk: 10240
  stemcell: default
  vm_type: t3.large
  azs:
  - z1
  networks:
   - name: services
  env:
    bosh:
      swap_size: 0
